<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SHOENIVERS</title>
  <link rel="stylesheet" href="index.css" />
  <!-- Icon chuẩn -->
  <link rel="icon" type="image/png" href="public/assets/logo/android-chrome-512x512.png">

  <!-- Nếu muốn hỗ trợ iOS/Android -->
  <link rel="apple-touch-icon" href="public/assets/logo/apple-touch-icon.png">
  <meta name="theme-color" content="#ffffff">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
  <header>
    <nav id="navbar" class="navbar">
      <div class="logo-container">
        <h1 class="logo">SHOENIVERS</h1>
        <p class="tagline">BETA ACCESS</p>
      </div>
      <ul class="nav-links">
        <li><a href="#intro">Trang chủ</a></li>
        <li><a href="#highlight">Nổi bật</a></li>
        <li><a href="#news">Tin tức</a></li>
        <li><a href="#footer">Về chúng tôi</a></li>
        <li><a href="products.html">Sản phẩm</a></li>

        <li><a href="#" id="cartBtn">Giỏ hàng (<span id="cartCount">0</span>)</a></li>
        <li>|</li>
        <li><a id="navbarLogin" href="login.html">Đăng nhập</a></li>
        <li><a id="navbarLogout" href="login.html" style="display:none;">Đăng xuất</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="intro" id="intro">
      <img src="public/assets/background.jpeg" alt="background">
      <div class="intro-content">
        <model-viewer src="public/assets/sport_shoe.glb" alt="Nike Air Force 1" camera-controls disable-zoom auto-rotate
          auto-rotate-delay="0" rotation-per-second="30deg" ar class="shoe-viewer">
        </model-viewer>
        <h2>THE UNIVERSE OF SHOE</h2>
        <p>Where the best quality shoes are waiting—not just for your budget, but for your lifestyle, your comfort, and
          your confidence. Whether you're chasing dreams, walking through daily challenges, or simply stepping into a
          new day, our shoes are designed to support every journey ahead—with style, durability, and affordability
          combined</p>
      </div>
      <div class="intro-button">
        <a href="login.html" style="text-decoration: none;"><button>Đăng nhập ngay</button></a>
      </div>
    </section>

    <section class="products" id="highlight">
      <h2>OUR HIGHLIGHT</h2>
      <div class="product-list" id="product-list"></div>
    </section>

    <!-- Modal chi tiết sản phẩm -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <img id="modalImage" src="${p.modalImg}" alt="">
        <div class="info">
          <h2 id="modalName"></h2>
          <p><strong>Giá:</strong> <span id="modalPrice"></span></p>
          <p><strong>Hãng:</strong> <span id="modalBrand"></span></p>
          <p>
            <strong>Size:</strong>
            <select id="modalSize">
              <option value="">Chọn size</option>
              <option value="38">38</option>
              <option value="39">39</option>
              <option value="40">40</option>
              <option value="41">41</option>
              <option value="42">42</option>
            </select>
          </p>
          <p><strong>Màu sắc:</strong> <span id="modalColor"></span></p>
          <p id="modalDesc"></p>
        </div>
        <div class="modal-button">
          <button id="btnAddCart" style="background-color: rgb(34, 34, 255)">Thêm vào giỏ hàng</button>
          <button id="btnBuy" style="background-color: rgb(38, 152, 0);">Mua</button>
          <button id="btnCloseModal" onclick="closeModal()" style="background-color: rgb(152, 0, 0);">Đóng</button>
        </div>
      </div>
    </div>

    <!-- Popup giỏ hàng -->
    <div id="cartPopup" class="cart-popup" aria-hidden="true">
      <h3>Giỏ hàng</h3>
      <ul id="cartItems"></ul>
      <p id="cartTotal"></p>
      <div class="cart-actions">
        <button onclick="clearCart()" id="clearCart">Xóa tất cả</button>
        <button onclick="closeCart()">Đóng</button>
      </div>
    </div>

    <section class="news" id="news">
      <h2>Tin tức & Báo chí</h2>
      <div class="news-list">
        <article class="news-item">
          <img src="public/assets/new1.jpg" alt="Tin 1">
          <h3>Shoenivers ra mắt bộ sưu tập giày thu đông 2025 – Đỉnh cao phong cách và sự thoải mái</h3>
          <p>Shoenivers chính thức giới thiệu bộ sưu tập Thu Đông 2025, mang đến trải nghiệm mới cho những tín đồ
            sneaker. Với cảm hứng từ đường phố New York và phong cách tối giản châu Âu, mỗi đôi giày được thiết kế để
            vừa êm ái, vừa thời trang, phù hợp từ đi làm đến đi chơi.
            Điểm đặc biệt là toàn bộ giày sử dụng đế CloudStep™ độc quyền giúp giảm sốc tối đa khi di chuyển. Bộ sưu tập
            hiện đã có mặt trên website và toàn bộ cửa hàng Shoenivers, với nhiều ưu đãi đặc biệt cho khách đặt sớm.</p>
          <a href="https://vn.louisvuitton.com/vie-vn/magazine/articles/men-fall-winter-2025-show" target="_blank">Xem
            chi tiết</a>
        </article>

        <article class="news-item">
          <img src="public/assets/new2.jpg" alt="Tin 2">
          <h3>Shoenivers bắt tay với nghệ sĩ Việt ra mắt phiên bản giới hạn</h3>
          <p>Shoenivers vừa công bố hợp tác với nghệ sĩ đường phố nổi tiếng KhoaLee để cho ra mắt dòng sneaker phiên bản
            giới hạn “Urban Canvas”. Mỗi đôi giày được vẽ thủ công từng chi tiết, biến chúng thành tác phẩm nghệ thuật
            có thể mang trên chân.
            Chỉ có 200 đôi trên toàn quốc, kèm chứng nhận độc quyền và chữ ký của nghệ sĩ. Đợt mở bán online đầu tiên đã
            cháy hàng trong 3 giờ. Dự kiến đợt mở bán tiếp theo sẽ diễn ra vào cuối tháng này – fan đừng bỏ lỡ!</p>
          <a href="https://www.lofficielvietnam.com/art-design/10-tac-pham-nghe-thuat-duong-pho-an-tuong-tren-the-gioi"
            target="_blank">Xem chi tiết</a>
        </article>
      </div>
    </section>

    <section id="footer">
      <footer class="footer">
        <div class="footer-container">

          <!-- Cột 1: Logo + Giới thiệu -->
          <div class="footer-section about">
            <h2>SHOENIVERS</h2>
            <hr>
            <br>
            <p>
              SHOENIVERS - Nơi hội tụ những đôi giày chất lượng và phong cách.
              Chúng tôi mang đến sự thoải mái và đẳng cấp cho từng bước chân của bạn.
            </p>
            <div class="social-icons">
              <a href="#"><i class="fa-brands fa-facebook"></i></a>
              <a href="#"><i class="fa-brands fa-instagram"></i></a>
              <a href="#"><i class="fa-brands fa-twitter"></i></a>
              <a href="#"><i class="fa-brands fa-youtube"></i></a>
            </div>
          </div>

          <!-- Cột 2: Liên hệ -->
          <div class="footer-section contact">
            <h3>Liên hệ</h3>
            <hr>
            <br>
            <p><i class="fa-solid fa-location-dot"></i> 123 Đường ABC, Quận 1, TP.HCM</p>
            <p><i class="fa-solid fa-phone"></i> +84 912 345 678</p>
            <p><i class="fa-solid fa-envelope"></i> shoenivers@gmail.com</p>
            <p><i class="fa-solid fa-clock"></i> Giờ mở cửa: 9:00 - 21:00 (T2 - CN)</p>
          </div>

          <!-- Cột 3: Liên kết nhanh -->
          <div class="footer-section links">
            <h3>Liên kết nhanh</h3>
            <hr>
            <br>
            <ul>
              <li><a href="#home">Trang chủ</a></li>
              <li><a href="#about">Giới thiệu</a></li>
              <li><a href="#products.html">Sản phẩm</a></li>
              <li><a href="#news">Tin tức</a></li>
              <li><a href="#contact">Liên hệ</a></li>
            </ul>
          </div>

          <!-- Cột 4: Google Map -->
          <div class="footer-section-map">
            <h3>Bản đồ</h3>
            <hr>
            <br>
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3919.3876847850834!2d106.67182831062068!3d10.781590189323186!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31752f002c2ba091%3A0xe78ce642de807847!2sSHOENIVERS!5e0!3m2!1svi!2sus!4v1755885446592!5m2!1svi!2sus"
              width="100%" height="200" style="border:0;" allowfullscreen="" loading="lazy">
            </iframe>
          </div>

        </div>

        <!-- Dòng cuối -->
        <div class="footer-bottom">
          <p>&copy; 2025 SHOENIVERS | All Rights Reserved</p>
        </div>
      </footer>

      <!-- Font Awesome -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    </section>


    <!-- Popup User -->
    <div id="userPopup" class="userpopup" aria-hidden="true">
      <div class="popup-content">
        <button id="closePopup" class="close-popup">&times;</button>
        <img id="popupAvatar" src="" alt="avatar" class="popup-avatar">
        <h3 id="popupName"></h3>
        <p id="popupEmail"></p>
        <hr>
        <br>
        <p id="popupRole"></p>
        <input type="file" id="avatarInput" style="display:none">
      </div>
    </div>

    <!-- Checkout popup (reused) -->
    <div id="checkoutPopup" class="popup">
      <div class="popup-checkout-content">
        <span class="close" onclick="closeCheckoutPopup()">&times;</span>
        <h2>Thanh toán</h2>

        <div class="checkout-grid">
          <div class="checkout-left">
            <h3>Giỏ hàng của bạn</h3>
            <ul id="checkoutItems"></ul>
            <div class="checkout-total" style="margin-top: 10px; text-align: right;">
              <strong>Tổng cộng:</strong> <span id="checkoutTotal">0</span> đ
            </div>
          </div>
          <div class="checkout-right">
            <h3>Thông tin thanh toán</h3>
            <form id="checkoutForm">
              <input type="text" id="fullname" placeholder="Họ và tên" required>
              <input type="tel" id="phone" placeholder="Số điện thoại" required>
              <input type="text" id="address" placeholder="Địa chỉ giao hàng" required>
              <label for="paymentMethod">Phương thức thanh toán</label>
              <select id="paymentMethod" required>
                <option value="">-- Chọn phương thức --</option>
                <option value="COD">Thanh toán khi nhận hàng (COD)</option>
                <option value="Bank">Chuyển khoản ngân hàng</option>
                <option value="Momo">Ví điện tử Momo</option>
              </select>
              <input type="text" id="promoCode" placeholder="Mã giảm giá">
              <button onclick="applyPromoCode()">Áp dụng</button>
              <div id="checkoutTotal_discount"></div>
              <textarea id="note" placeholder="Ghi chú"></textarea>
              <button type="submit">Xác nhận thanh toán</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Popup QR -->
    <div id="qrPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
      <div class="qr-popup-content" style="background:#fff; padding:20px; border-radius:10px; text-align:center;">
        <h3>Quét mã để thanh toán</h3>
        <img id="qrImage" src="" alt="QR Code" style="max-width:500px; display:block; margin:0 auto;">
        <br>
        <button id="confirmPaidBtn">Xác nhận đã thanh toán</button>
        <button id="cancelBtn">Hủy</button>
      </div>
    </div>



  </main>
  <div id="toast-container"></div>

  <!-- DÀNH CHO ADMIN -->
  <!-- Nút nổi -->
  <div id="admin-nodes">
    <div id="adminNode" class="fab">
      <img src="public/assets/icon/setting.png" alt="Admin" />
    </div>
    <!-- Các node con -->
    <div id="fabImage" class="fab-sub">
      <span class="fab-label">Thay đổi hình nền</span>
      <img src="public/assets/icon/image.png" alt="Thay đổi hình nền" />
    </div>
    <div id="fabProduct" class="fab-sub">
      <span class="fab-label">Quản lý sản phẩm</span>
      <img src="public/assets/icon/sneaker.png" alt="Quản lý sản phẩm" />
    </div>
    <div id="fabRevenue" class="fab-sub">
      <span class="fab-label">Quản lý doanh thu</span>
      <img src="public/assets/icon/cash.png" alt="Quản lý doanh thu" />
    </div>
  </div>


  <!-- Popup quản lý sản phẩm -->
  <div id="adminProductPopup" class="popup" style="display:none;">
    <div class="popup-content">

      <!-- Bên trái: danh sách -->
      <div id="productListWrapper">
        <h2>Danh sách sản phẩm</h2>
        <ul id="adminProductList"></ul>
      </div>

      <!-- Bên phải: form -->
      <div id="adminProductForm">
        <h2>Thêm / Sửa sản phẩm</h2>
        <br>
        <input id="prodName" placeholder="Tên sản phẩm">
        <input id="prodPrice" type="number" placeholder="Giá">
        <input id="prodImg" placeholder="Link ảnh sản phẩm">
        <input type="file" id="prodImgFile" accept="image/*">
        <div id="imgPreviewWrapper">
          <img id="imgPreview" style="max-width:150px; display:none; margin-top:10px;" />
        </div>
        <input id="modalImg" placeholder="Link ảnh modal">
        <input type="file" id="modalImgFile" accept="image/*">
        <div id="modalImgPreviewWrapper">
          <img id="modalImgPreview" style="max-width:150px; display:none; margin-top:10px;" />
        </div>


        <label for="prodBrand">Hãng:</label>
        <select id="prodBrand">
          <option value="Nike">Nike</option>
          <option value="Adidas">Adidas</option>
          <option value="Puma">Puma</option>
          <option value="Converse">Converse</option>
          <option value="Vans">Vans</option>
          <option value="Reebok">Reebok</option>
          <option value="Asics">Asics</option>
        </select>

        <label for="prodColor">Màu sắc:</label>
        <select id="prodColor">
          <option value="Đen">Đen</option>
          <option value="Trắng">Trắng</option>
          <option value="Đỏ">Đỏ</option>
          <option value="Xanh">Xanh</option>
          <option value="Vàng">Vàng</option>
          <option value="Hồng">Hồng</option>
          <option value="Xám">Xám</option>
          <option value="Nâu">Nâu</option>
        </select>

        <div class="form-actions">
          <button id="btnSaveProduct" onclick="addProduct()">Thêm sản phẩm</button>
          <button id="btnCancelProduct" onclick="closePopup('adminProductPopup')">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Thống kê doanh thu -->
  <!-- Popup doanh thu -->
  <div id="revenueModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div class="revenue-left">
        <h2>Thống kê doanh thu</h2>
        <canvas id="revenueChart"></canvas>
      </div>
      <div class="revenue-right">
        <h2>Danh sách đơn hàng</h2>
        <table id="orderTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tên KH</th>
              <th>SĐT</th>
              <th>Địa chỉ</th>
              <th>Tổng</th>
              <th>Giảm giá</th>
              <th>Thanh toán</th>
              <th>Ngày</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>






  <script>
    // SNAP SCROLLING
    let isScrolling = false;
    let currentSection = 0; // 0 = intro, 1 = products
    const sections = document.querySelectorAll("main section");

    //Snap scroll
    function snapHandler(e) {
      if (isScrolling) return;
      isScrolling = true;

      if (e.deltaY > 0) {
        currentSection = Math.min(currentSection + 1, sections.length - 1);
      } else {
        currentSection = Math.max(currentSection - 1, 0);
      }

      window.scrollTo({
        top: sections[currentSection].offsetTop,
        behavior: "smooth"
      });

      setTimeout(() => {
        isScrolling = false;
      }, 300);
    }
    window.addEventListener("wheel", snapHandler);


    // helper keys
    const USERS_KEY = 'users_list';
    const CURRENT_USER_KEY = 'current_user';

    // NAVBAR SCROLL EFFECT
    const navbar = document.getElementById('navbar');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) navbar.classList.add('scrolled'); else navbar.classList.remove('scrolled');
    });

    // PRODUCT SCROLL
    const slider = document.querySelector('.product-list');
    let isDown = false;
    let startX;
    let scrollLeft;

    slider.addEventListener('mousedown', (e) => {
      isDown = true;
      slider.classList.add('active');
      startX = e.pageX - slider.offsetLeft;
      scrollLeft = slider.scrollLeft;
    });

    slider.addEventListener('mouseleave', () => {
      isDown = false;
      slider.classList.remove('active');
    });

    slider.addEventListener('mouseup', () => {
      isDown = false;
      slider.classList.remove('active');
    });

    slider.addEventListener('mousemove', (e) => {
      if (!isDown) return; // Chỉ chạy khi đang giữ chuột
      e.preventDefault();
      const x = e.pageX - slider.offsetLeft;
      const walk = (x - startX) * 1.5; // tốc độ kéo
      slider.scrollLeft = scrollLeft - walk;
    });


    // Render products data
    let products = JSON.parse(localStorage.getItem("products")) || [];
    let editIndex = null;

    function saveProducts() {
      localStorage.setItem("products", JSON.stringify(products));
      renderAdminProductList();
      renderShopProducts();
    }

    function renderAdminProductList() {
      const listEl = document.getElementById("adminProductList");
      listEl.innerHTML = "";

      if (products.length === 0) {
        listEl.innerHTML = "<li>Chưa có sản phẩm nào</li>";
        return;
      }

      products.forEach((prod, index) => {
        const li = document.createElement("li");
        li.classList.add("product-item");
        li.innerHTML = `
      <div class="img-frame"><img src="${prod.img}" alt="${prod.name}" class="product-thumb"></div>
      <div class="product-info">
        <strong>${prod.name}</strong> ${Number(prod.price).toLocaleString()}đ <hr>
        <strong>Hãng</strong>: ${prod.brand} 
        <br><strong>Màu</strong>: ${prod.color}
      </div>
      <div class="product-actions">
        <button onclick="editProduct(${index})">Sửa</button>
        <button onclick="deleteProduct(${index})">Xóa</button>
      </div>
    `;
        listEl.appendChild(li);
      });
    }

    // ================== PREVIEW ẢNH CHÍNH ==================
    const prodImgFile = document.getElementById("prodImgFile");
    const imgPreview = document.getElementById("imgPreview");

    prodImgFile.addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imgPreview.src = e.target.result;
          imgPreview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        imgPreview.src = "";
        imgPreview.style.display = "none";
      }
    });

    // ================== PREVIEW ẢNH MODAL ==================
    const modalImgFile = document.getElementById("modalImgFile");
    const modalImgPreview = document.getElementById("modalImgPreview");

    modalImgFile.addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          modalImgPreview.src = e.target.result;
          modalImgPreview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        modalImgPreview.src = "";
        modalImgPreview.style.display = "none";
      }
    });

    // ================== ADD / EDIT PRODUCT ==================
    function addProduct() {
      const name = document.getElementById("prodName").value.trim();
      const price = parseFloat(document.getElementById("prodPrice").value);
      const brand = document.getElementById("prodBrand").value;
      const color = document.getElementById("prodColor").value;

      const imgLink = document.getElementById("prodImg").value.trim();
      const fileInput = document.getElementById("prodImgFile");
      const file = fileInput.files[0];

      const modalImgLink = document.getElementById("modalImg").value.trim();
      const modalFileInput = document.getElementById("modalImgFile");
      const modalFile = modalFileInput.files[0];

      if (!name || isNaN(price) || (!imgLink && !file)) {
        showToast("Vui lòng nhập đủ thông tin hoặc chọn ảnh!");
        return;
      }

      // debug check
      console.log("Thêm/Sửa sản phẩm:", { name, price, brand, color, imgLink, file, modalImgLink, modalFile });

      // Lưu sản phẩm sau khi đã xử lý ảnh
      const saveProductData = (imgSrc, modalImgSrc) => {
        const product = { id: Date.now(), name, price, img: imgSrc, modalImg: modalImgSrc, brand, color };

        if (editIndex === null) {
          products.push(product);
          console.log("Đã thêm sản phẩm mới:", product);
          showToast("Thêm sản phẩm thành công!");
        } else {
          product.id = products[editIndex].id; // giữ id cũ
          products[editIndex] = product;
          console.log("Đã sửa sản phẩm:", product);
          showToast("Sửa sản phẩm thành công!");
          editIndex = null;
          document.getElementById("btnSaveProduct").innerText = "Thêm sản phẩm";
        }

        saveProducts();
        resetForm();
      };

      // Xử lý chuỗi bất đồng bộ cho cả ảnh chính và modal
      const handleModalImage = (mainImgSrc) => {
        if (modalFile) {
          const reader = new FileReader();
          reader.onload = function (e) {
            saveProductData(mainImgSrc, e.target.result);
          };
          reader.readAsDataURL(modalFile);
        } else {
          saveProductData(mainImgSrc, modalImgLink || "");
        }
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          handleModalImage(e.target.result);
        };
        reader.readAsDataURL(file);
      } else {
        handleModalImage(imgLink);
      }
    }

    function resetForm() {
      document.getElementById("prodName").value = "";
      document.getElementById("prodPrice").value = "";
      document.getElementById("prodImg").value = "";
      document.getElementById("prodImgFile").value = "";
      document.getElementById("modalImg").value = "";
      document.getElementById("modalImgFile").value = "";
      document.getElementById("prodBrand").value = "Nike";
      document.getElementById("prodColor").value = "Đen";
      document.getElementById("btnSaveProduct").innerText = "Thêm sản phẩm";
      imgPreview.style.display = "none";
      modalImgPreview.style.display = "none";
      editIndex = null;
    }

    function editProduct(index) {
      const prod = products[index];
      document.getElementById("prodName").value = prod.name;
      document.getElementById("prodPrice").value = prod.price;
      document.getElementById("prodImg").value = prod.img;
      document.getElementById("prodBrand").value = prod.brand;
      document.getElementById("prodColor").value = prod.color;
      document.getElementById("modalImg").value = prod.modalImg || "";
      document.getElementById("btnSaveProduct").innerText = "Lưu sản phẩm";
      editIndex = index;

      // Hiện preview
      imgPreview.src = prod.img;
      imgPreview.style.display = "block";

      if (prod.modalImg) {
        modalImgPreview.src = prod.modalImg;
        modalImgPreview.style.display = "block";
      } else {
        modalImgPreview.src = "";
        modalImgPreview.style.display = "none";
      }
    }

    function deleteProduct(index) {
      if (confirm("Xóa sản phẩm này?")) {
        products.splice(index, 1);
        saveProducts();
        showToast("Xóa sản phẩm thành công!");
      }
    }



    //Hiển thị hộp sản phẩm
    function renderShopProducts() {
      const productList = document.getElementById("product-list");
      productList.innerHTML = '';
      products.forEach(p => {
        productList.innerHTML += `
        <div class="product-item">
        <img src="${p.img}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p>Giá: ${p.price.toLocaleString()}đ</p>
        <div class="product-button-group">
        <button onclick="openModal(${p.id})">Xem chi tiết</button>
        <button class="quick-add" onclick="quickAddToCart(${p.id})"><i class="fa-solid fa-cart-plus"></i></button>
        </div>
        </div>
        `;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderAdminProductList();
      renderShopProducts();
    });

    // Modal logic (single modal)
    function openModal(id) {
      const product = products.find(p => p.id === id);
      document.getElementById("modalImage").src = product.modalImg;
      document.getElementById("modalName").textContent = product.name;
      document.getElementById("modalPrice").textContent = product.price.toLocaleString() + "đ";
      document.getElementById("modalBrand").textContent = product.brand;
      document.getElementById("modalColor").textContent = product.color;
      document.getElementById("modalDesc").textContent = product.desc;

      document.getElementById("btnAddCart").onclick = () => addCart(product.id);
      document.getElementById("btnBuy").onclick = () => buyNow(product.id);

      document.getElementById("productModal").style.display = "flex";
    }
    function closeModal() { document.getElementById("productModal").style.display = "none"; }

    // USER: helpers
    function getUsers() { return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
    function saveUsers(u) { localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
    function getCurrentUser() { return JSON.parse(localStorage.getItem(CURRENT_USER_KEY) || 'null'); }
    function setCurrentUser(u) { localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(u)); updateNavbar(); updateCartCount(); }

    // PROFILE POPUP
    function showProfilePopup(user) {
      if (!user) return;
      document.getElementById('popupAvatar').src = user.avatar || 'public/assets/default_avatar.jpg';
      document.getElementById('popupName').textContent = user.displayName || user.name || '';
      document.getElementById('popupEmail').textContent = user.username || user.email || '';
      document.getElementById('popupRole').textContent = "ROLE: " + (user.role || 'Người dùng');
      document.getElementById('userPopup').style.display = 'block';
    }
    document.getElementById('closePopup').addEventListener('click', () => document.getElementById('userPopup').style.display = 'none');
    document.getElementById('popupAvatar').addEventListener('click', () => document.getElementById('avatarInput').click());
    document.getElementById('avatarInput').addEventListener('change', function () {

      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const newAvatar = e.target.result;
        let cur = getCurrentUser();
        if (!cur) return showToast('Bạn cần đăng nhập để đổi avatar');
        cur.avatar = newAvatar;
        setCurrentUser(cur);
        // update users list
        let users = getUsers();
        users = users.map(u => (u.username === cur.username ? { ...u, avatar: newAvatar } : u));
        saveUsers(users);
        document.getElementById('popupAvatar').src = newAvatar;
      }
      reader.readAsDataURL(file);
    });

    // CART per-user
    function cartKeyForUser(username) { return `cart_${username}`; }
    function getCart() { const u = getCurrentUser(); if (!u) return []; return JSON.parse(localStorage.getItem(cartKeyForUser(u.username)) || '[]'); }
    function saveCart(cart) { const u = getCurrentUser(); if (!u) return; localStorage.setItem(cartKeyForUser(u.username), JSON.stringify(cart)); updateCartCount(); }

    function addCart(id) {
      const user = getCurrentUser();
      if (!user) { showToast('Vui lòng đăng nhập để thêm sản phẩm.'); return; }
      let cart = getCart();
      const product = products.find(p => p.id === id);
      // increase qty if exists
      const exist = cart.find(i => i.id === id);
      if (exist) { exist.qty = (exist.qty || 1) + 1; } else { cart.push({ id: product.id, name: product.name, price: product.price, qty: 1, img: product.img }); }
      saveCart(cart);
      showToast('Đã thêm ' + product.name + ' vào giỏ hàng!');
      renderCartPopup();
    }

    //Thêm giỏ hàng nhanh
    function quickAddToCart(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;

      const u = getCurrentUser();
      if (!u) {
        showToast("Vui lòng đăng nhập để thêm vào giỏ hàng!");
        return;
      }

      let cart = JSON.parse(localStorage.getItem(cartKeyForUser(u.username))) || [];

      // increase qty if exists
      const exist = cart.find(i => i.id === id);
      if (exist) {
        exist.qty = (exist.qty || 1) + 1;
      } else {
        cart.push({
          id: product.id,
          name: product.name,
          price: product.price,
          qty: 1,
          img: product.img
        });
      }

      saveCart(cart);
      showToast("Đã thêm " + product.name + " vào giỏ hàng!");
      renderCartPopup();
    }

    function buyNow(id) {
      const user = getCurrentUser();
      if (!user) {
        showToast('Vui lòng đăng nhập để mua sản phẩm.');
        return;
      }

      let cart = getCart();
      const product = products.find(p => p.id === id);

      if (!product) {
        showToast('Sản phẩm không tồn tại.');
        return;
      }

      // Nếu sản phẩm chưa có trong giỏ thì thêm vào giỏ trước
      let exist = cart.find(i => i.id === id);
      if (!exist) {
        exist = { id: product.id, name: product.name, price: product.price, qty: 1, img: product.img };
        cart.push(exist);
        saveCart(cart);
      }

      // Gọi checkout để render popup
      checkout();

      // Sau khi render xong thì chỉnh lại checkbox
      document.querySelectorAll('.checkout-item-check').forEach(chk => {
        if (chk.dataset.id === String(id)) {
          chk.checked = true;   // chỉ tick sản phẩm vừa mua
        } else {
          chk.checked = false;  // các sản phẩm khác bỏ tick
        }
      });

      // Tính lại tổng
      updateCheckoutTotal();
    }


    function showToast(msg) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerText = msg;

      container.appendChild(toast);

      // Xoá sau 3s
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }


    function renderCartPopup() {
      const cart = getCart();
      const list = document.getElementById('cartItems');
      list.innerHTML = '';
      let total = 0;

      if (cart.length === 0) {
        list.innerHTML = '<li>Giỏ hàng trống</li>';
        document.getElementById('cartTotal').textContent = '';
        return;
      }

      cart.forEach((it, idx) => {
        total += it.price * (it.qty || 1);
        list.innerHTML += `<li>
        <img src="${it.img}" alt="" style="width:46px;height:46px;object-fit:cover;border-radius:6px;margin-right:8px;vertical-align:middle;">
        ${it.name} <b>${(it.price).toLocaleString()}đ</b> x ${it.qty || 1}
        <button onclick="removeFromCart(${idx})" style="float:right;background:#000;color:#fff;border:none;padding:4px 8px;border-radius:10px;cursor:pointer;">X</button>
      </li>`;
      });

      document.getElementById('cartTotal').innerHTML = `
      <div style="margin-top:8px; text-align: right;">
        <span>Tổng: ${total.toLocaleString()}đ</span>
        <button onclick="checkout()" style="margin-left:10px;padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:10px;cursor:pointer;">
          Thanh toán
        </button>
      </div>`;
      document.body.classList.add("noscroll"); // ❌ tắt scroll
    }

    // Hashtable chứa mã giảm giá và % giảm
    const promoCodes = {
      "SALE10": 10,
      "SALE20": 20,
      "FREESHIP": 0,
      "SALE100": 100
    };

    // Lưu % giảm giá hiện tại
    let currentDiscountPercent = 0;

    // Áp dụng mã giảm giá
    function applyPromoCode() {
      const inputCode = document.getElementById("promoCode").value.trim().toUpperCase();

      if (promoCodes.hasOwnProperty(inputCode)) {
        currentDiscountPercent = promoCodes[inputCode];
        showToast(`Áp dụng mã ${inputCode}: giảm ${currentDiscountPercent}%`);
      } else {
        currentDiscountPercent = 0;
        showToast("Mã giảm giá không hợp lệ");
      }

      updateCheckoutTotal();
    }

    function checkout() {
      const cart = getCart();
      const list = document.getElementById('checkoutItems');
      list.innerHTML = '';

      let total = 0;

      if (cart.length === 0) {
        list.innerHTML = '<li>Giỏ hàng trống</li>';
        document.getElementById('checkoutTotal').textContent = '0';
      } else {
        cart.forEach(it => {
          const itemTotal = it.price * (it.qty || 1);
          total += itemTotal;

          list.innerHTML += `
        <li>
          <input type="checkbox" class="checkout-item-check" data-id="${it.id}" checked>
          <img src="${it.img}" alt="">
          <div class="item-info">
            <div>${it.name}</div>
            <div>Số lượng: ${it.qty || 1}</div>
          </div>
          <div class="item-price">${itemTotal.toLocaleString()}đ</div>
        </li>
      `;
        });

        document.getElementById('checkoutTotal').textContent = total.toLocaleString();
      }

      document.querySelectorAll('.checkout-item-check').forEach(chk => {
        chk.addEventListener('change', updateCheckoutTotal);
      });

      document.getElementById('checkoutPopup').style.display = 'block';
    }

    function updateCheckoutTotal() {
      const cart = getCart();
      let total = 0;

      document.querySelectorAll('.checkout-item-check:checked').forEach(chk => {
        const id = parseInt(chk.getAttribute('data-id'));
        const item = cart.find(i => i.id === id);
        if (item) {
          total += item.price * (item.qty || 1);
        }
      });

      // Tính tiền giảm giá
      const discountAmount = currentDiscountPercent > 0
        ? total * currentDiscountPercent / 100
        : 0;

      const finalTotal = total - discountAmount;

      // Hiển thị chi tiết
      document.getElementById('checkoutTotal_discount').innerHTML = `
      <div>Tổng ban đầu: ${total.toLocaleString()}đ</div>
      ${discountAmount > 0 ? `<div>Giảm ${currentDiscountPercent}%: -${discountAmount.toLocaleString()}đ</div>` : ''}
      <div><b>Tổng thanh toán: ${finalTotal.toLocaleString()}đ</b></div>
      `;

      // Áp dụng % giảm giá nếu có
      if (currentDiscountPercent > 0) {
        total = total - (total * currentDiscountPercent / 100);
      }

      document.getElementById('checkoutTotal').textContent = total.toLocaleString();
    }

    function closeCheckoutPopup() {
      document.getElementById('checkoutPopup').style.display = 'none';
    }

    document.getElementById('checkoutForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const name = document.getElementById('fullname').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const promoCode = document.getElementById('promoCode').value.trim();
      const paymentMethod = document.getElementById('paymentMethod').value;

      if (!name || !phone || !address || !paymentMethod) {
        showToast('Vui lòng điền đầy đủ thông tin và chọn phương thức thanh toán!');
        return;
      }

      // Nếu là Bank hoặc Momo => hiện popup QR
      if (paymentMethod === "Bank" || paymentMethod === "Momo") {
        const qrImage = document.getElementById("qrImage");
        qrImage.src = paymentMethod === "Bank" ? "public/assets/qr/qr-bank.jpg" : "./public/assets/qr/qr-momo.jpg";

        document.getElementById("qrPopup").style.display = "flex";

        // Gắn sự kiện xác nhận thanh toán
        document.getElementById("confirmPaidBtn").onclick = function () {
          document.getElementById("qrPopup").style.display = "none";
          finishPayment(name, phone, address, promoCode, paymentMethod);
        };

        // Nút hủy
        document.getElementById("cancelBtn").onclick = function () {
          document.getElementById("qrPopup").style.display = "none";
        };
        closeCheckoutPopup();
        showToast("Vui lòng quét mã QR để thanh toán. Sau khi quét, nhấn 'Xác nhận đã thanh toán' để hoàn tất.");
        return; // Dừng ở đây, chờ user xác nhận
      }

      // Nếu COD thì thanh toán luôn
      finishPayment(name, phone, address, promoCode, paymentMethod);
    });

    // Hàm xử lý khi thanh toán thành công
    function finishPayment(name, phone, address, promoCode, paymentMethod) {
      const user = getCurrentUser();
      const cart = getCart();
      if (!user || cart.length === 0) return;

      const checkedIds = Array.from(document.querySelectorAll('.checkout-item-check:checked'))
        .map(chk => parseInt(chk.dataset.id));
      const items = cart.filter(it => checkedIds.includes(it.id));

      let total = items.reduce((sum, it) => sum + it.price * (it.qty || 1), 0);
      let discount = currentDiscountPercent > 0 ? total * currentDiscountPercent / 100 : 0;
      let finalTotal = total - discount;

      const order = {
        id: Date.now(),
        customer: { name, phone, address, username: user.username },
        items: items.map(it => ({
          productId: it.id,
          qty: it.qty || 1
        })),
        total: finalTotal,
        discount,
        promoCode,
        paymentMethod,
        date: new Date().toISOString()
      };

      let orders = getOrders();
      orders.push(order);
      saveOrders(orders);

      localStorage.removeItem(cartKeyForUser(user.username));
      updateCartCount();
      renderCartPopup();
      closeCheckoutPopup();

      showToast(
        `Thanh toán thành công!\n` +
        `Mã đơn: ${order.id}\n` +
        `Tổng: ${finalTotal.toLocaleString()}đ`
      );
    }


    // LƯU ORDER
    function getOrders() {
      return JSON.parse(localStorage.getItem("orders")) || [];
    }

    function saveOrders(orders) {
      localStorage.setItem("orders", JSON.stringify(orders));
    }


    function removeFromCart(index) { let cart = getCart(); if (index < 0 || index >= cart.length) return; cart.splice(index, 1); saveCart(cart); renderCartPopup(); }
    function clearCart() { const cur = getCurrentUser(); if (!cur) return; localStorage.removeItem(cartKeyForUser(cur.username)); renderCartPopup(); updateCartCount(); }
    function showCart() { renderCartPopup(); document.getElementById('cartPopup').style.display = 'block'; }
    function closeCart() { document.getElementById('cartPopup').style.display = 'none'; }

    function updateCartCount() { const cur = getCurrentUser(); const el = document.getElementById('cartCount'); if (!cur) { el.textContent = '0'; return; } const cart = getCart(); const count = cart.reduce((s, i) => s + (i.qty || 1), 0); el.textContent = count; }

    document.getElementById('cartBtn').addEventListener('click', (e) => { e.preventDefault(); const popup = document.getElementById('cartPopup'); if (popup.style.display === 'block') { closeCart(); } else { showCart(); } });

    // update navbar if logged in
    function updateNavbar() {
      const cur = getCurrentUser();
      const navbarLogin = document.getElementById('navbarLogin');
      const introBtn = document.querySelector('.intro-button');
      const cartBtn = document.getElementById('cartBtn');
      let logoutLink = document.getElementById('navbarLogout');

      if (cur) {
        // Ẩn intro button
        if (introBtn) introBtn.style.display = 'none';

        // Cập nhật nút login thành avatar + tên
        navbarLogin.innerHTML = `
      <img src="${cur.avatar || 'public/assets/default_avatar.jpg'}"
           class="nav-avatar"
           style="width:24px;height:24px;border-radius:50%;margin-right:6px;vertical-align:middle;">
      ${cur.displayName || cur.name}
    `;
        navbarLogin.href = '#';
        navbarLogin.onclick = (e) => { e.preventDefault(); showProfilePopup(cur); };

        // Nếu chưa có nút logout thì tạo
        if (!logoutLink) {
          logoutLink = document.createElement('li');
          logoutLink.innerHTML = `<a href="#" id="navbarLogout">Đăng xuất</a>`;
          document.querySelector('.nav-links').appendChild(logoutLink);
        }
        if (logoutLink.style.display === 'none') {
          logoutLink.style.display = '';
        }

        // Gán sự kiện logout
        document.getElementById('navbarLogout').onclick = (e) => {
          e.preventDefault();
          logoutUser(); // Hàm xóa user khỏi localStorage/session
          updateNavbar();
        };

      } else {
        // Hiện intro button lại
        if (introBtn) introBtn.style.display = '';
        // Ẩn cart button
        if (cartBtn) cartBtn.style.display = 'none';
        // Cập nhật lại nút login
        navbarLogin.textContent = 'Đăng nhập';
        navbarLogin.href = 'login.html';
        navbarLogin.onclick = null;

        // Xóa nút logout nếu có
        if (logoutLink) logoutLink.remove();
      }
    }
    // LOGOUT USER
    function logoutUser() {
      // Xóa thông tin user khỏi localStorage
      localStorage.removeItem('current_user');

      // Nếu muốn xóa luôn sessionStorage
      sessionStorage.removeItem('current_user');

      // (Tùy chọn) Thông báo
      console.log('Đã đăng xuất');

      // Nếu muốn chuyển về trang chủ sau khi đăng xuất
      window.location.href = 'login.html';
    }


    //if user logined, the intro-button is hide
    document.addEventListener("DOMContentLoaded", () => {
      const user = getCurrentUser();
      const introBtn = document.querySelector(".intro-button");
      const adminNode = document.getElementById("admin-nodes");
      if (user && introBtn) {
        introBtn.style.display = "none";
      }
      //check role
      if (user && user.role === "admin") {
        adminNode.style.display = "flex";
      }
    });

    //Phần dành cho admin
    const fabMain = document.getElementById("adminNode");
    const fabImage = document.getElementById("fabImage");
    const fabProduct = document.getElementById("fabProduct");
    const fabRevenue = document.getElementById("fabRevenue");

    let isFabOpen = false;

    fabMain.addEventListener("click", () => {
      isFabOpen = !isFabOpen;
      if (isFabOpen) {
        fabImage.classList.add("show");
        fabImage.style.bottom = "90px";

        fabProduct.classList.add("show");
        fabProduct.style.bottom = "150px";

        fabRevenue.classList.add("show");
        fabRevenue.style.bottom = "210px";
      } else {
        [fabImage, fabProduct, fabRevenue].forEach(node => {
          node.classList.remove("show");
          node.style.bottom = "20px";
        });
      }
    });

    // ====== Action của các node con ======
    fabImage.addEventListener("click", () => {
      document.body.style.backgroundImage = "url('https://picsum.photos/1200/800')";
      document.body.style.backgroundSize = "cover";
      showToast("Đã thay đổi hình nền!");
    });

    fabProduct.addEventListener("click", () => {
      const popupId = "adminProductPopup";
      const popup = document.getElementById(popupId);

      if (popup.classList.contains("show")) {
        closePopup(popupId);
      } else {
        openPopup(popupId);
        renderAdminProductList();
      }
    });


    fabRevenue.addEventListener("click", () => {
      if (document.getElementById("revenueModal").style.display === "flex") {
        closePopup("revenueModal");
      } else {
        // Nút close trong Revenue Popup
        document.querySelector("#revenueModal .close").addEventListener("click", () => {
          closePopup("revenueModal");
        });
        openPopup("revenueModal");
        renderRevenueChart();
        renderOrderTable();
      }
    });

    //--THỐNG KÊ--

    //lấy tổng doanh thu
    function getTotalRevenue() {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      return orders.reduce((sum, o) => sum + o.total, 0);
    }
    //Thống kê doanh thu theo ngày
    function getRevenueByDate() {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      const revenueMap = {};

      orders.forEach(o => {
        const date = new Date(o.date).toLocaleDateString("vi-VN");
        revenueMap[date] = (revenueMap[date] || 0) + o.total;
      });

      return revenueMap;
    }

    //render ra chart
    function renderRevenueChart() {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];

      if (orders.length === 0) {
        console.log("⚠️ Không có orders => không render chart");
        document.getElementById("revenueChart").style.display = "none";
        return;
      }

      const revenueByDate = {};
      orders.forEach(o => {
        const date = new Date(o.date).toLocaleDateString("vi-VN");
        revenueByDate[date] = (revenueByDate[date] || 0) + o.total;
      });

      const labels = Object.keys(revenueByDate);
      const data = Object.values(revenueByDate);

      const ctx = document.getElementById("revenueChart").getContext("2d");

      // ✅ Kiểm tra đúng instance trước khi destroy
      if (window.revenueChart && typeof window.revenueChart.destroy === "function") {
        window.revenueChart.destroy();
      }

      window.revenueChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Doanh thu (VNĐ)",
            data: data,
            backgroundColor: "rgba(75,192,192,0.6)",
            borderColor: "rgba(75,192,192,1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => value.toLocaleString("vi-VN") + "đ"
              }
            }
          }
        }
      });
    }


    function renderOrderTable() {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      const tbody = document.querySelector("#orderTable tbody");
      tbody.innerHTML = "";

      orders.forEach(o => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td>${o.id}</td>
      <td>${o.customer.name}</td>
      <td>${o.customer.phone}</td>
      <td>${o.customer.address}</td>
      <td>${o.total.toLocaleString()}đ</td>
      <td>${o.discount ? o.discount.toLocaleString() + "đ" : "-"}</td>
      <td>${o.paymentMethod}</td>
      <td>${new Date(o.date).toLocaleString("vi-VN")}</td>
    `;
        tbody.appendChild(tr);
      });
    }



    //Bánh răng xoay
    const fab = document.querySelector(".fab");
    fab.addEventListener("click", () => {
      fab.classList.toggle("active");
    });



    // ====== POPUP MANAGER ======
    const popupIds = ["adminProductPopup", "revenueModal", "productModal", "cartPopup", "checkoutPopup", "userPopup", "qrPopup"];

    function closeAllPopups() {
      popupIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
      });
      window.addEventListener("wheel", snapHandler);
    }

    function openPopup(id) {
      closeAllPopups();
      const popup = document.getElementById(id);
      if (popup) {
        popup.style.display = "flex";
        popup.classList.add("show");
        window.removeEventListener("wheel", snapHandler);
      }
    }

    function closePopup(id) {
      const popup = document.getElementById(id);
      if (popup) {
        popup.classList.remove("show");
        setTimeout(() => {
          popup.style.display = "none";
          window.addEventListener("wheel", snapHandler);
        }, 200);
      }
    }

    // ESC để đóng popup
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeAllPopups();
      }
    });

    // Click ra ngoài để đóng popup
    popupIds.forEach(id => {
      const popup = document.getElementById(id);
      if (popup) {
        popup.addEventListener("click", (e) => {
          if (e.target === popup) closePopup(id);
        });
      }
    });


    // init
    updateNavbar();
    updateCartCount();

  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</body>

</html>